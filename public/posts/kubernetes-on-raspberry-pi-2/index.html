<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubernetes on Raspberry Pi - Part 2 | Chun Wu</title>
<meta name=keywords content="kubernetes,homelab,raspberrypi,k3s,ansibible"><meta name=description content="Multi-part series on working with Kubernetes"><meta name=author content="Me"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/kubernetes-on-raspberry-pi-2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Kubernetes on Raspberry Pi - Part 2"><meta property="og:description" content="Multi-part series on working with Kubernetes"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/kubernetes-on-raspberry-pi-2/"><meta property="og:image" content="http://localhost:1313/images/k8s-raspberry-pi/ansible.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-08T09:30:03+00:00"><meta property="article:modified_time" content="2024-06-08T09:30:03+00:00"><meta property="og:site_name" content="Chun Wu"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/images/k8s-raspberry-pi/ansible.png"><meta name=twitter:title content="Kubernetes on Raspberry Pi - Part 2"><meta name=twitter:description content="Multi-part series on working with Kubernetes"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Kubernetes on Raspberry Pi - Part 2","item":"http://localhost:1313/posts/kubernetes-on-raspberry-pi-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes on Raspberry Pi - Part 2","name":"Kubernetes on Raspberry Pi - Part 2","description":"Multi-part series on working with Kubernetes","keywords":["kubernetes","homelab","raspberrypi","k3s","ansibible"],"articleBody":"Ansible As I am aware that this will not be the last time I will rebuild this cluster (I plan setup HA on the controlplane at a later time)I need a way to automate and simplify the cluster rebuild process each time. Enter Ansible. Ansible is an open-source automation tool that simplifies complex IT tasks. Written in Python, it allows you to automate various operations, such as system configuration, software deployment, and workflow orchestration. Ansible’s strengths lie in its simplicity and ease of use, making it a popular choice for managing infrastructure and achieving operational excellence across different platforms\nInstalling Ansible The only dependency that Ansible has is Python installed on your local machine. If you are on a Mac like myself it is fairly simple to install. (I use brew for package management)\nbrew install ansible # Alternatively # pip3 install ansible For other operating systems, its fairly simple to find alternative package managers to get Ansible installed (choco, yum, apt, etc.)\nCreating an Inventory File Ansible will use an inventory file to communicate with my servers. Like a hosts file on your local machine (found at /etc/hosts), which matches IP addresses to domain names. Ansible’s inventory file matches the IP addresses I’ve configured on my Raspberry Pi’s to groups. Hosts file can be either .ini or .yaml, since my inventory is relatively simple I will be using a INI file. For more complex inventories, I would recommend defining your inventory in YAML.\nMy inventory file looks like the following:\n# Control Plane Nodes [controlplane] controlplane1 ansible_host=192.168.1.100 # Worker Nodes [workers] worker1 ansible_host=192.168.1.101 worker2 ansible_host=192.168.1.102 worker3 ansible_host=192.168.1.103 # Group 'bramble' with all k3s nodes. [bramble:children] controlplane workers # Variables that will be applied to all [bramble:vars] ansible_ssh_private_key_file=~/.ssh/id_rsa [controlplane] and [workers] are groups that I have defined. [bramble:children] is a group of groups. I defined in each respective line the hostname of the node and the local IP address of the node on my network. Finally I defined a group variable that specifies the desired SSH private key I want Ansible to use when communicating with my nodes. Ad-Hoc Ansible Command Now that I have Ansible installed and created an inventory file, let’s just run a command to validate everything is functional.\nansible controlplane -m ping -u chunwu [WARNING]: Platform linux on host cp1 is using the discovered Python interpreter at /usr/bin/python3.11, but future installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible- core/2.17/reference_appendices/interpreter_discovery.html for more information. cp1 | SUCCESS =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python3.11\" }, \"changed\": false, \"ping\": \"pong\" } The ad-hoc command above will ping all nodes in the group controlplane. In my case, since I only have one node specified I only get a response from one node. I also specified my a username of chunwu which is how I configured Raspberry Pi OS when I imaged the SD cards.\nK3s Before I jump into the specific Ansible playbook for my cluster configuration, let’s dive into steps if we were to do this manually.\nCGroup Configuration Other guides you may find online will ask you to modify /boot/firmware/cmdline.txt but more recently the file you need to modify is /boot/cmdline.txt. The cmdline.txt file is a configuration file, located in the boot paritition of the SD card on Raspberry Pi, and used to pass additional parameters to the Linux Kernel for the system boot. Read more about cgroups here\n# 1. Open the cmdline.txt file sudo vim /boot/firmware/cmdline.txt #2. Add below into THE END of the current line cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory # 3. Save the file and reboot sudo shutdown -r now Master Node Installation Run the following command to install the K3s master node.\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=\"server --disable=traefik --flannel-backend=host-gw --tls-san=192.168.1.85 --bind-address=192.168.1.85 --advertise-address=192.168.1.100 --node-ip=192.168.1.100 --cluster-init\" sh -s - There a multitude of ways to configure K3s installation, more details can be found in the documentation. In the command I have specified…\nserver: This is telling k3s to run in server mode (as opposed to agent mode). In server mode, k3s will start up and manage Kubernetes master components. disable=traefik: This is instructing k3s to disable the Traefik ingress controller. By default, k3s includes and enables Traefik; this flag will prevent that from happening. I plan to install at a later time using Helm. flannel-backend=host-gw: This flag is setting the backend for Flannel (k3s’s default network provider) to use. The host-gw option provides high-performance networking by creating a route for each node in the cluster. tls-san=192.168.1.85: The — tls-san flag allows you to specify additional IP or DNS names that should be included in the TLS certificate that is automatically generated for the Kubernetes API server. You can repeat this flag to add more than one SAN. The value 192.168.1.85 is an additional Subjective Alternative Name (SAN) for the Kubernetes API server’s certificate. bind-address=192.168.1.85: This is the IP address that the k3s API server will listen on. advertise-address=192.168.1.85: This is the IP address that the k3s API server will advertise to other nodes in the cluster. They will use this IP to connect to the API server. node-ip=192.168.1.85: This defines the IP that should be used for Kubernetes services on the nod cluster-init: This flag instructs k3s to initialize a new Kubernetes cluster. If this flag is not provided, k3s will join an existing cluster if one is available. As evolve my configuration I keep this section up to date. Once installed, the k3s configuration should be located in /etc/rancher/k3s/k3s.yaml. I recommend changing the file permissions and creating a k3s configuration file in your ~/.kube/conf.yaml local machine so that you can access your cluster.\nWorker Node Installation To install the worker nodes, we first need to obtain the K3S_TOKEN from the master node. Execute the command shown below to retrieve it:\n# get node-token from master node sudo cat /var/lib/rancher/k3s/server/node-token Upon retrieval of the node token, it is necessary to inject it into the script shown below. This script should be executed on all the Pi nodes specified previously. Please ensure to update the IP address associated with K3S_URL, as required.\n# Execute this to install the nodes curl -sfL https://get.k3s.io | K3S_URL=https://192.168.1.100:6443 \\ K3S_TOKEN=\"\" sh - That’s it your cluster is now configured! But that’s an awful a lot of work to repeat manually if wish to ever rebuild your cluster.\nAnsible Playbook The following Ansible playbook will do everything I mentioned above:\n--- - name: Node Preparation become: true hosts: bramble tasks: - name: Ping Host ping: - name: Enable Cgroups lineinfile: path: /boot/firmware/cmdline.txt backrefs: true regexp: '^((?!.*\\bcgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory\\b).*)$' line: '\\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory' notify: - Restart Raspberry Pi handlers: - name: Restart Raspberry Pi reboot: - name: Install k3s on controlplane become: true hosts: controlplane tasks: - name: Ping Host ping: - name: Install K3s on controlplane server shell: 'curl -sfL https://get.k3s.io | sh -' - name: Give k3s time to startup agent pause: seconds: 60 - name: Extract K3S_TOKEN from server output command: cat /var/lib/rancher/k3s/server/node-token register: k3s_token failed_when: k3s_token is failed or k3s_token.stdout is undefined - name: Set K3S_Token as a fact set_fact: k3s_token: \"{{ k3s_token.stdout }}\" - name: Install k3s on workers nodes become: true hosts: workers tasks: - name: Ping hosts ping: - name: Install k3s onto worker nodes shell: curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars['cp1']['ansible_default_ipv4'].address }}:6443 K3S_TOKEN={{ hostvars['cp1']['k3s_token'] }} K3S_NODE_NAME={{ inventory_hostname }} sh - - name: Get k3s kubeconfig become: true hosts: controlplane tasks: - name: Fetch kubeconfig fetch: src: /etc/rancher/k3s/k3s.yaml dest: k3sconfig flat: true You can also refer to my Github repository.\nWhat’s Next? There are several different paths I can take with this guide on Part 3, stay tuned!\n","wordCount":"1267","inLanguage":"en","image":"http://localhost:1313/images/k8s-raspberry-pi/ansible.png","datePublished":"2024-06-08T09:30:03Z","dateModified":"2024-06-08T09:30:03Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/kubernetes-on-raspberry-pi-2/"},"publisher":{"@type":"Organization","name":"Chun Wu","logo":{"@type":"ImageObject","url":"http://localhost:1313/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Chun Wu (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Chun Wu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/archives/ title=archives><span>archives</span></a></li><li><a href=http://localhost:1313/categories/ title=categories><span>categories</span></a></li><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li><li><a href=http://localhost:1313/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Kubernetes on Raspberry Pi - Part 2
<span class=entry-hint title=Draft><svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-description>Multi-part series on working with Kubernetes</div><div class=post-meta><span title='2024-06-08 09:30:03 +0000 +0000'>June 8, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1267 words&nbsp;·&nbsp;Me</div></header><figure class=entry-cover><img loading=eager src=http://localhost:1313/images/k8s-raspberry-pi/ansible.png alt=Ansible><p>Automation with Ansible</p></figure><div class=post-content><h2 id=ansible>Ansible<a hidden class=anchor aria-hidden=true href=#ansible>#</a></h2><p>As I am aware that this will not be the last time I will rebuild this cluster (I plan setup HA on the controlplane at a later time)I need a way to automate and simplify the cluster rebuild process each time. Enter Ansible. Ansible is an open-source automation tool that simplifies complex IT tasks. Written in Python, it allows you to automate various operations, such as system configuration, software deployment, and workflow orchestration. Ansible’s strengths lie in its simplicity and ease of use, making it a popular choice for managing infrastructure and achieving operational excellence across different platforms</p><h3 id=installing-ansible>Installing Ansible<a hidden class=anchor aria-hidden=true href=#installing-ansible>#</a></h3><p>The only dependency that Ansible has is Python installed on your local machine. If you are on a Mac like myself it is fairly simple to install. (I use brew for package management)</p><pre tabindex=0><code>brew install ansible

# Alternatively
# pip3 install ansible
</code></pre><p>For other operating systems, its fairly simple to find alternative package managers to get Ansible installed (choco, yum, apt, etc.)</p><h3 id=creating-an-inventory-file>Creating an Inventory File<a hidden class=anchor aria-hidden=true href=#creating-an-inventory-file>#</a></h3><p>Ansible will use an inventory file to communicate with my servers. Like a hosts file on your local machine (found at /etc/hosts), which matches IP addresses to domain names. Ansible&rsquo;s inventory file matches the IP addresses I&rsquo;ve configured on my Raspberry Pi&rsquo;s to groups. Hosts file can be either <code>.ini</code> or <code>.yaml</code>, since my inventory is relatively simple I will be using a INI file. For more complex inventories, I would recommend defining your inventory in YAML.</p><p>My inventory file looks like the following:</p><pre tabindex=0><code># Control Plane Nodes
[controlplane]
controlplane1 ansible_host=192.168.1.100 

# Worker Nodes
[workers]
worker1 ansible_host=192.168.1.101 
worker2 ansible_host=192.168.1.102 
worker3 ansible_host=192.168.1.103 

# Group &#39;bramble&#39; with all k3s nodes.
[bramble:children]
controlplane
workers

# Variables that will be applied to all
[bramble:vars]
ansible_ssh_private_key_file=~/.ssh/id_rsa
</code></pre><ul><li>[controlplane] and [workers] are groups that I have defined.</li><li>[bramble:children] is a group of groups.</li><li>I defined in each respective line the hostname of the node and the local IP address of the node on my network.</li><li>Finally I defined a group variable that specifies the desired SSH private key I want Ansible to use when communicating with my nodes.</li></ul><h3 id=ad-hoc-ansible-command>Ad-Hoc Ansible Command<a hidden class=anchor aria-hidden=true href=#ad-hoc-ansible-command>#</a></h3><p>Now that I have Ansible installed and created an inventory file, let&rsquo;s just run a command to validate everything is functional.</p><pre tabindex=0><code>ansible controlplane -m ping -u chunwu

[WARNING]: Platform linux on host cp1 is using the discovered Python interpreter at
/usr/bin/python3.11, but future installation of another Python interpreter could change the meaning
of that path. See https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
cp1 | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python3.11&#34;
    },
    &#34;changed&#34;: false,
    &#34;ping&#34;: &#34;pong&#34;
}
</code></pre><p>The ad-hoc command above will ping all nodes in the group <code>controlplane</code>. In my case, since I only have one node specified I only get a response from one node. I also specified my a username of <code>chunwu</code> which is how I configured Raspberry Pi OS when I imaged the SD cards.</p><h2 id=k3s>K3s<a hidden class=anchor aria-hidden=true href=#k3s>#</a></h2><p>Before I jump into the specific Ansible playbook for my cluster configuration, let&rsquo;s dive into steps if we were to do this manually.</p><h3 id=cgroup-configuration>CGroup Configuration<a hidden class=anchor aria-hidden=true href=#cgroup-configuration>#</a></h3><p>Other guides you may find online will ask you to modify <code>/boot/firmware/cmdline.txt</code> but more recently the file you need to modify is <code>/boot/cmdline.txt</code>. The <code>cmdline.txt</code> file is a configuration file, located in the boot paritition of the SD card on Raspberry Pi, and used to pass additional parameters to the Linux Kernel for the system boot. Read more about cgroups <a href=https://www.man7.org/linux/man-pages/man7/cgroups.7.html>here</a></p><pre tabindex=0><code># 1. Open the cmdline.txt file
sudo vim /boot/firmware/cmdline.txt

#2. Add below into THE END of the current line
cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory

# 3. Save the file and reboot
sudo shutdown -r now
</code></pre><h3 id=master-node-installation>Master Node Installation<a hidden class=anchor aria-hidden=true href=#master-node-installation>#</a></h3><p>Run the following command to install the K3s master node.</p><pre tabindex=0><code>curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&#34;server --disable=traefik --flannel-backend=host-gw --tls-san=192.168.1.85 --bind-address=192.168.1.85 --advertise-address=192.168.1.100 --node-ip=192.168.1.100 --cluster-init&#34; sh -s -
</code></pre><p>There a multitude of ways to configure K3s installation, more details can be found in the <a href=https://docs.k3s.io/installation/configuration>documentation</a>. In the command I have specified&mldr;</p><ul><li>server: This is telling k3s to run in server mode (as opposed to agent mode). In server mode, k3s will start up and manage Kubernetes master components.</li><li>disable=traefik: This is instructing k3s to disable the Traefik ingress controller. By default, k3s includes and enables Traefik; this flag will prevent that from happening. I plan to install at a later time using Helm.</li><li>flannel-backend=host-gw: This flag is setting the backend for Flannel (k3s’s default network provider) to use. The host-gw option provides high-performance networking by creating a route for each node in the cluster.</li><li>tls-san=192.168.1.85: The — tls-san flag allows you to specify additional IP or DNS names that should be included in the TLS certificate that is automatically generated for the Kubernetes API server. You can repeat this flag to add more than one SAN. The value 192.168.1.85 is an additional Subjective Alternative Name (SAN) for the Kubernetes API server’s certificate.</li><li>bind-address=192.168.1.85: This is the IP address that the k3s API server will listen on.</li><li>advertise-address=192.168.1.85: This is the IP address that the k3s API server will advertise to other nodes in the cluster. They will use this IP to connect to the API server.</li><li>node-ip=192.168.1.85: This defines the IP that should be used for Kubernetes services on the nod</li><li>cluster-init: This flag instructs k3s to initialize a new Kubernetes cluster. If this flag is not provided, k3s will join an existing cluster if one is available.</li></ul><p>As evolve my configuration I keep this section up to date. Once installed, the k3s configuration should be located in <code>/etc/rancher/k3s/k3s.yaml</code>. I recommend changing the file permissions and creating a <code>k3s</code> configuration file in your <code>~/.kube/conf.yaml</code> local machine so that you can access your cluster.</p><h3 id=worker-node-installation>Worker Node Installation<a hidden class=anchor aria-hidden=true href=#worker-node-installation>#</a></h3><p>To install the worker nodes, we first need to obtain the K3S_TOKEN from the master node. Execute the command shown below to retrieve it:</p><pre tabindex=0><code># get node-token from master node
sudo cat /var/lib/rancher/k3s/server/node-token
</code></pre><p>Upon retrieval of the node token, it is necessary to inject it into the script shown below. This script should be executed on all the Pi nodes specified previously. Please ensure to update the IP address associated with K3S_URL, as required.</p><pre tabindex=0><code># Execute this to install the nodes
curl -sfL https://get.k3s.io | K3S_URL=https://192.168.1.100:6443 \
  K3S_TOKEN=&#34;&lt;token&gt;&#34; sh -
</code></pre><p>That&rsquo;s it your cluster is now configured! But that&rsquo;s an awful a lot of work to repeat manually if wish to ever rebuild your cluster.</p><h2 id=ansible-playbook>Ansible Playbook<a hidden class=anchor aria-hidden=true href=#ansible-playbook>#</a></h2><p>The following Ansible playbook will do everything I mentioned above:</p><pre tabindex=0><code>---
- name: Node Preparation
  become: true
  hosts: bramble
  tasks:
  - name: Ping Host
    ping: 
  - name: Enable Cgroups
    lineinfile:
      path: /boot/firmware/cmdline.txt
      backrefs: true
      regexp: &#39;^((?!.*\bcgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory\b).*)$&#39;
      line: &#39;\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory&#39;
    notify: 
    - Restart Raspberry Pi
  handlers:
  - name: Restart Raspberry Pi
    reboot:

- name: Install k3s on controlplane
  become: true
  hosts: controlplane
  tasks:
  - name: Ping Host
    ping:
  - name: Install K3s on controlplane server
    shell: &#39;curl -sfL https://get.k3s.io | sh -&#39;
  - name: Give k3s time to startup agent
    pause:
      seconds: 60
  - name: Extract K3S_TOKEN from server output
    command: cat /var/lib/rancher/k3s/server/node-token
    register: k3s_token
    failed_when: k3s_token is failed or k3s_token.stdout is undefined
  - name: Set K3S_Token as a fact
    set_fact:
      k3s_token: &#34;{{ k3s_token.stdout }}&#34;

- name: Install k3s on workers nodes
  become: true
  hosts: workers
  tasks:
  - name: Ping hosts
    ping:
  - name: Install k3s onto worker nodes
    shell: curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars[&#39;cp1&#39;][&#39;ansible_default_ipv4&#39;].address }}:6443 K3S_TOKEN={{ hostvars[&#39;cp1&#39;][&#39;k3s_token&#39;] }} K3S_NODE_NAME={{ inventory_hostname }} sh -

- name: Get k3s kubeconfig
  become: true
  hosts: controlplane
  tasks:
  - name: Fetch kubeconfig
    fetch: 
      src: /etc/rancher/k3s/k3s.yaml
      dest: k3sconfig
      flat: true
</code></pre><p>You can also refer to my <a href=https://github.com/CPWu/raspberry-pi-bramble/tree/main/playbooks>Github repository</a>.</p><h2 id=whats-next>What&rsquo;s Next?<a hidden class=anchor aria-hidden=true href=#whats-next>#</a></h2><p>There are several different paths I can take with this guide on Part 3, stay tuned!</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/kubernetes/>Kubernetes</a></li><li><a href=http://localhost:1313/tags/homelab/>Homelab</a></li><li><a href=http://localhost:1313/tags/raspberrypi/>Raspberrypi</a></li><li><a href=http://localhost:1313/tags/k3s/>K3s</a></li><li><a href=http://localhost:1313/tags/ansibible/>Ansibible</a></li></ul><nav class=paginav><a class=next href=http://localhost:1313/posts/kubernetes-on-raspberry-pi/><span class=title>Next »</span><br><span>Kubernetes on Raspberry Pi - Part 1</span></a></nav></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://chunwu.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Chun Wu</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>